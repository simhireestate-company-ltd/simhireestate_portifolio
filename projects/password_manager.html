<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SimHireEstate â€” Password Manager (Offline)</title>
  <link rel="icon" href="../assets/logo.png" />
  <style>
    :root { --brand-primary:#063F5E; --brand-secondary:#1a1a69; --brand-gray:#6B7280; }
    *{ box-sizing: border-box; }
    body{ margin:0; font-family:'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background:#f8fafc; color:#0f172a; }
    header{ position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb; }
    .wrap{ max-width: 1100px; margin:0 auto; padding:16px; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand span{ color:var(--brand-primary); font-weight:600; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; }
    .grid{ display:grid; gap:16px; }
    @media(min-width:900px){ .grid-2{ grid-template-columns:1fr 1fr; } }
    label{ font-size:.9rem; color:#334155; }
    input, select, textarea, button{ font:inherit; }
    input, select, textarea{ width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; }
    .btn{ padding:10px 14px; border-radius:8px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
    .btn-primary{ background:var(--brand-secondary); color:#fff; border-color:transparent; }
    .muted{ color:#64748b; font-size:.9rem; }
    table{ width:100%; border-collapse: collapse; }
    th, td{ border-bottom:1px solid #e5e7eb; padding:10px; text-align:left; font-size:.95rem; }
    th{ background:#f1f5f9; color:#0f172a; }
    .actions{ display:flex; gap:6px; }
    @media print{ header, .controls, .no-print { display:none !important; } body{ background:#fff; } .wrap{ max-width:100%; padding:0 12px; } .card{ border:none; padding:0; } }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; align-items:center; justify-content:space-between; height:64px;">
      <a href="../projects.html" class="brand" title="Back to Projects">
        <img src="../assets/logo.png" alt="SimHireEstate" style="height:28px; width:auto" />
        <span>SimHireEstate</span>
      </a>
      <div class="muted">Password Manager (Encrypted, Local)</div>
    </div>
  </header>

  <main class="wrap" style="padding-top:16px; padding-bottom:24px;">
    <section class="card" style="margin-bottom:12px;">
      <h2>Master Password</h2>
      <div class="grid grid-2">
        <div>
          <label for="master">Enter master password (keep it safe!)</label>
          <input type="password" id="master" />
        </div>
        <div class="no-print" style="align-self:end; display:flex; gap:8px;">
          <button class="btn btn-primary" id="unlockBtn">Unlock</button>
          <button class="btn" id="lockBtn">Lock</button>
        </div>
      </div>
      <p class="muted">Data is encrypted with your master password and stored locally in your browser. If you forget it, data cannot be recovered.</p>
    </section>

    <section class="card">
      <div class="controls no-print" style="display:flex; gap:8px; flex-wrap:wrap; align-items:end;">
        <div style="flex:1; min-width:220px;">
          <label for="site">Website / App</label>
          <input id="site" placeholder="example.com" />
        </div>
        <div style="flex:1; min-width:180px;">
          <label for="username">Username / Email</label>
          <input id="username" />
        </div>
        <div style="flex:1; min-width:180px;">
          <label for="password">Password</label>
          <input id="password" />
        </div>
        <div style="min-width:160px;">
          <label for="notes">Notes</label>
          <input id="notes" />
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn btn-primary" id="addBtn">Add / Update</button>
          <button class="btn" id="genBtn">Generate</button>
          <button class="btn" id="exportBtn">Export</button>
          <button class="btn" id="importBtn">Import</button>
          <button class="btn" id="printBtn">Print</button>
        </div>
      </div>

      <div style="overflow:auto; margin-top:10px;">
        <table>
          <thead>
            <tr><th>Website</th><th>Username</th><th>Password</th><th>Notes</th><th class="no-print">Actions</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const STORAGE_KEY = 'passwordVaultV1';
    let vault = []; // decrypted array in-memory
    let unlocked = false;
    let masterKey = null; // CryptoKey

    // Crypto helpers: PBKDF2 derive key from passphrase, then AES-GCM encrypt/decrypt
    async function deriveKey(pass, salt){
      const enc = new TextEncoder();
      const baseKey = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey({ name:'PBKDF2', salt, iterations:100000, hash:'SHA-256' }, baseKey, { name:'AES-GCM', length:256 }, false, ['encrypt','decrypt']);
    }

    async function encryptJSON(obj, key){
      const enc = new TextEncoder();
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const k = await deriveKey(document.getElementById('master').value, salt);
      const data = enc.encode(JSON.stringify(obj));
      const cipher = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, k, data);
      return { iv: Array.from(iv), salt: Array.from(salt), cipher: Array.from(new Uint8Array(cipher)) };
    }

    async function decryptJSON(payload, pass){
      const dec = new TextDecoder();
      const iv = new Uint8Array(payload.iv);
      const salt = new Uint8Array(payload.salt);
      const cipher = new Uint8Array(payload.cipher);
      const k = await deriveKey(pass, salt);
      const plain = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, k, cipher);
      return JSON.parse(dec.decode(new Uint8Array(plain)));
    }

    function saveVaultEncrypted(){
      encryptJSON(vault).then(payload => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        alert('Saved');
      });
    }

    async function tryLoadVault(){
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) { vault = []; return true; }
      try{
        const payload = JSON.parse(saved);
        vault = await decryptJSON(payload, document.getElementById('master').value);
        return true;
      } catch(e){ alert('Wrong master password or corrupted data.'); return false; }
    }

    function render(){
      const tbody = document.getElementById('rows');
      tbody.innerHTML = '';
      vault.sort((a,b)=> a.site.localeCompare(b.site));
      for (const row of vault){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(row.site)}</td>
                        <td>${escapeHtml(row.username)}</td>
                        <td><input type="password" value="${escapeHtml(row.password)}" style="width:100%" /></td>
                        <td>${escapeHtml(row.notes||'')}</td>
                        <td class="no-print actions">
                          <button class="btn btn-sm" data-act="edit">Edit</button>
                          <button class="btn btn-sm" data-act="copy">Copy</button>
                          <button class="btn btn-sm" data-act="delete">Delete</button>
                        </td>`;
        tr.querySelector('[data-act="edit"]').onclick = ()=>{
          document.getElementById('site').value = row.site;
          document.getElementById('username').value = row.username;
          document.getElementById('password').value = row.password;
          document.getElementById('notes').value = row.notes||'';
        };
        tr.querySelector('[data-act="copy"]').onclick = ()=>{ navigator.clipboard.writeText(row.password); alert('Copied'); };
        tr.querySelector('[data-act="delete"]').onclick = ()=>{ if (confirm('Delete?')){ vault = vault.filter(x=> !(x.site===row.site && x.username===row.username)); saveVaultEncrypted(); render(); } };
        tbody.appendChild(tr);
      }
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    document.getElementById('unlockBtn').onclick = async ()=>{
      if (!document.getElementById('master').value){ alert('Enter master password'); return; }
      const ok = await tryLoadVault();
      if (ok){ unlocked = true; render(); alert('Unlocked'); }
    };
    document.getElementById('lockBtn').onclick = ()=>{ unlocked=false; document.getElementById('master').value=''; document.getElementById('rows').innerHTML=''; };

    document.getElementById('addBtn').onclick = ()=>{
      if (!unlocked) return alert('Unlock first');
      const site = document.getElementById('site').value.trim();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const notes = document.getElementById('notes').value;
      if (!site || !username || !password) return alert('Fill all required fields');
      const idx = vault.findIndex(r=> r.site===site && r.username===username);
      if (idx>=0) vault[idx] = { site, username, password, notes };
      else vault.push({ site, username, password, notes });
      saveVaultEncrypted(); render();
      document.getElementById('site').value=''; document.getElementById('username').value=''; document.getElementById('password').value=''; document.getElementById('notes').value='';
    };

    document.getElementById('genBtn').onclick = ()=>{
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_-+=[]{};:,.?/';
      let out=''; for(let i=0;i<16;i++){ out += chars[Math.floor(Math.random()*chars.length)]; }
      document.getElementById('password').value = out;
    };

    document.getElementById('exportBtn').onclick = ()=>{
      if (!unlocked) return alert('Unlock first');
      const a = document.createElement('a');
      a.href = 'data:application/json,' + encodeURIComponent(JSON.stringify(vault, null, 2));
      a.download = 'vault.json'; a.click();
    };

    document.getElementById('importBtn').onclick = ()=>{
      if (!unlocked) return alert('Unlock first');
      const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange = async ()=>{
        const f = inp.files?.[0]; if (!f) return; const text = await f.text();
        try{ const data = JSON.parse(text); if (Array.isArray(data)){ vault = mergeVault(vault, data); saveVaultEncrypted(); render(); } else alert('Invalid file'); }
        catch(e){ alert('Invalid JSON'); }
      };
      inp.click();
    };

    function mergeVault(oldArr, newArr){
      const map = new Map(oldArr.map(x=> [x.site+'|'+x.username, x]));
      for(const r of newArr){ map.set(r.site+'|'+r.username, r); }
      return Array.from(map.values());
    }

    document.getElementById('printBtn').onclick = ()=> window.print();
  </script>
</body>
</html>